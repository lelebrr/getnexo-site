---
// Cookie Consent Banner LGPD Compliant - Discreet Version
---

<div id="cookie-consent-banner" class="cookie-banner" style="display: none;">
  <div class="cookie-glass">
    <button id="close-cookie-banner" class="close-btn" aria-label="Fechar">&times;</button>
    <div class="cookie-summary">
      <div class="cookie-icon-spin">üç™</div>
      <div class="cookie-text">
        <p>
          Este site usa cookies para melhorar sua experi√™ncia.
          <button id="btn-details" class="link-btn">Personalizar</button>
        </p>
      </div>
    </div>

    <!-- Hidden by default, shown via JS toggle -->
    <div id="cookie-details" class="cookie-details hidden">
      <div class="cookie-options">
        <div class="cookie-option">
          <div class="option-header">
            <input type="checkbox" id="essential-cookies" checked disabled />
            <label for="essential-cookies">Essenciais</label>
          </div>
          <p class="option-desc">Necess√°rios para o funcionamento.</p>
        </div>

        <div class="cookie-option">
          <div class="option-header">
            <input type="checkbox" id="analytics-cookies" />
            <label for="analytics-cookies">Analytics</label>
          </div>
          <p class="option-desc">Nos ajuda a melhorar o conte√∫do.</p>
        </div>

        <div class="cookie-option">
          <div class="option-header">
            <input type="checkbox" id="preference-cookies" />
            <label for="preference-cookies">Prefer√™ncias</label>
          </div>
          <p class="option-desc">Salva suas configura√ß√µes.</p>
        </div>
      </div>
      
      <div class="policy-link">
        <a href="/privacidade" target="_blank">Pol√≠tica de Privacidade</a>
      </div>
    </div>

    <div class="cookie-actions">
      <button id="reject-all" class="btn-text">Recusar</button>
      <button id="accept-all" class="btn-primary">Aceitar</button>
    </div>
    <!-- Hidden "Save Preferences" button shown only when details open -->
    <button id="save-prefs" class="btn-save hidden">Salvar Prefer√™ncias</button>
  </div>
</div>

<style>
  .cookie-banner {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem; /* Floating bottom-right */
    z-index: 10000;
    width: 320px; /* Much smaller width */
    font-family: 'Inter', system-ui, sans-serif;
    animation: fadeSlideIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .cookie-glass {
    background: rgba(10, 15, 30, 0.6); /* High transparency dark */
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    padding: 1rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    transition: all 0.3s ease;
  }

  .cookie-glass:hover {
    background: rgba(10, 15, 30, 0.75);
    border-color: rgba(255, 255, 255, 0.15);
  }

  .cookie-summary {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
  }

  .cookie-icon-spin {
    font-size: 1.25rem;
    animation: spinSlow 10s linear infinite;
  }

  @keyframes spinSlow { to { transform: rotate(360deg); } }

  .cookie-text p {
    margin: 0;
    font-size: 0.85rem;
    color: #e2e8f0;
    line-height: 1.4;
  }

  .link-btn {
    background: none;
    border: none;
    color: #00d4ff;
    cursor: pointer;
    font-size: 0.85rem;
    padding: 0;
    text-decoration: underline;
    text-underline-offset: 2px;
    margin-left: 4px;
    font-weight: 500;
  }

  .link-btn:hover {
    color: #00ff9d;
  }

  /* DETAILS SECTION */
  .cookie-details {
    overflow: hidden;
    transition: max-height 0.4s ease, opacity 0.4s ease;
    max-height: 500px;
    opacity: 1;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding-top: 0.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }

  .close-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: transparent;
    border: none;
    color: #94a3b8;
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    padding: 0.2rem;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: 0.2s;
    z-index: 20;
  }

  .close-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
  }

  .cookie-details.hidden {
    max-height: 0;
    opacity: 0;
    pointer-events: none;
    padding-top: 0;
    margin: 0;
    border: none;
  }

  .cookie-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .cookie-option {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
  }

  .option-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .option-header input {
    accent-color: #00d4ff;
    cursor: pointer;
  }
  
  .option-header label {
    font-size: 0.8rem;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
  }

  .option-desc {
    margin: 0;
    font-size: 0.7rem;
    color: #94a3b8;
    padding-left: 1.3rem;
  }

  .policy-link a {
    font-size: 0.7rem;
    color: #64748b;
    text-decoration: none;
  }
  .policy-link a:hover { color: #94a3b8; }

  /* ACTIONS */
  .cookie-actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    margin-top: 0.25rem;
  }

  .btn-text {
    background: none;
    border: none;
    color: #94a3b8;
    font-size: 0.85rem;
    cursor: pointer;
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    transition: 0.2s;
  }

  .btn-text:hover {
    background: rgba(255,255,255,0.05);
    color: #fff;
  }

  .btn-primary {
    background: linear-gradient(135deg, #00d4ff, #00ff9d);
    border: none;
    color: #0f172a;
    font-weight: 600;
    font-size: 0.85rem;
    padding: 0.4rem 1.2rem;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.2s;
    flex-grow: 1; /* Make it prominent */
    max-width: 120px;
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 212, 255, 0.2);
  }

  .btn-save {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 0.8rem;
    padding: 0.4rem;
    width: 100%;
    border-radius: 8px;
    cursor: pointer;
    display: none; /* hidden by default, managed by JS */
  }

  .btn-save:hover {
    background: rgba(255, 255, 255, 0.15);
  }

  /* MOBILE RESPONSIVE */
  @media (max-width: 480px) {
    .cookie-banner {
      left: 1rem;
      right: 1rem;
      bottom: 1rem;
      width: auto;
    }
  }

  @keyframes fadeSlideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<script>
  interface Window {
    gtag?: (...args: any[]) => void;
    [key: string]: any;
  }

  class CookieConsentManager {
    banner: HTMLElement | null;
    details: HTMLElement | null;
    btnDetails: HTMLElement | null;
    btnSave: HTMLElement | null;
    actions: HTMLElement | null;
    detailsOpen: boolean;
    consent: any;

    constructor() {
      this.banner = document.getElementById('cookie-consent-banner');
      this.details = document.getElementById('cookie-details');
      this.btnDetails = document.getElementById('btn-details');
      this.btnSave = document.getElementById('save-prefs');
      this.actions = document.querySelector('.cookie-actions');
      this.detailsOpen = false;

      this.consent = this.getStoredConsent();

      if (!this.consent) {
        this.showBanner();
        this.bindEvents();
      } else {
        this.applyConsent(this.consent);
      }
    }

    showBanner() {
      if(this.banner) this.banner.style.display = 'block';
    }

    bindEvents() {
      // Toggle Details
      if (this.btnDetails) {
        this.btnDetails.addEventListener('click', (e) => {
          e.preventDefault();
          this.toggleDetails();
        });
      }

      // Accept All
      const acceptAll = document.getElementById('accept-all');
      if (acceptAll) acceptAll.addEventListener('click', () => {
        this.setConsent({ essential: true, analytics: true, preference: true, timestamp: Date.now() });
      });

      // Reject All (Non-essential)
      const rejectAll = document.getElementById('reject-all');
      if (rejectAll) rejectAll.addEventListener('click', () => {
        this.setConsent({ essential: true, analytics: false, preference: false, timestamp: Date.now() });
      });

      // Save Preferences (only visible when details open)
      if (this.btnSave) {
        this.btnSave.addEventListener('click', () => {
          const analytics = (document.getElementById('analytics-cookies') as HTMLInputElement).checked;
          const preference = (document.getElementById('preference-cookies') as HTMLInputElement).checked;
          this.setConsent({ essential: true, analytics, preference, timestamp: Date.now() });
        });
      }

      // Close Button (X)
      const closeBtn = document.getElementById('close-cookie-banner');
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          if (this.banner) this.banner.style.display = 'none';
        });
      }
    }

    toggleDetails() {
      this.detailsOpen = !this.detailsOpen;
      if (this.detailsOpen && this.details && this.btnDetails) {
        this.details.classList.remove('hidden');
        this.btnDetails.textContent = 'Menos op√ß√µes';
        if(this.btnSave) this.btnSave.style.display = 'block';
        if(this.actions) this.actions.style.display = 'none';
      } else if (this.details && this.btnDetails) {
        this.details.classList.add('hidden');
        this.btnDetails.textContent = 'Personalizar';
        if(this.btnSave) this.btnSave.style.display = 'none';
        if(this.actions) this.actions.style.display = 'flex';
      }
    }

    setConsent(consent: any) {
      localStorage.setItem('cookie-consent', JSON.stringify(consent));
      this.consent = consent;
      if (this.banner) this.banner.style.display = 'none';
      this.applyConsent(consent);
      
      const win = window as any;
      if (consent.analytics && win.gtag) {
        win.gtag('consent', 'update', { analytics_storage: 'granted' });
      }
    }

    getStoredConsent() {
      const stored = localStorage.getItem('cookie-consent');
      return stored ? JSON.parse(stored) : null;
    }

    applyConsent(consent: any) {
      const win = window as any;
      if (!consent.analytics) {
        win['ga-disable-G-F8P994EX00'] = true;
        if (win.gtag) win.gtag('consent', 'default', { analytics_storage: 'denied' });
      }
      if (!consent.preference) {
        localStorage.removeItem('nexo-a11y-settings');
      }
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new CookieConsentManager());
  } else {
    new CookieConsentManager();
  }
</script>