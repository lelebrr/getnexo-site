---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Configuração de IA - GetNexo Admin">

  <h1 style="color:#00ff9d; font-size:2.8rem;">Configuração de IA</h1>
  <p style="color:#e5e7eb; margin-bottom:2rem;">Escolha qual IA o chat usa na demo e em produção. Cole as chaves API aqui.</p>

  <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:2rem;">

    <!-- Gemini -->
    <div class="card" style="background:rgba(30,41,59,0.8); padding:2rem; border-radius:16px; border:1px solid #00d4ff55;">
      <h3 style="color:#00d4ff;">Google Gemini</h3>
      <select id="gemini-model-select" style="width:100%; padding:0.8rem; margin:0.8rem 0; background:#1e293b; color:white; border:1px solid #00d4ff55;">
        <option value="gemini-2.0-flash" selected>Gemini 2.0 Flash (Mais novo)</option>
        <option value="gemini-2.0-flash-lite-preview-02-05">Gemini 2.0 Flash Lite (Preview)</option>
        <option value="gemini-1.5-pro">Gemini 1.5 Pro (Mais inteligente)</option>
        <option value="gemini-1.5-flash">Gemini 1.5 Flash (Rápido)</option>
      </select>
      <input id="gemini-key" type="text" placeholder="Cole sua API Key Gemini aqui" style="width:100%; padding:0.8rem; background:#1e293b; color:white; border:1px solid #00d4ff55;" />
      <button onclick="saveConfig('gemini')" class="btn-cta" style="margin-top:1rem; width:100%;">Salvar Gemini</button>
    </div>

    <!-- OpenRouter -->
    <div class="card" style="background:rgba(30,41,59,0.8); padding:2rem; border-radius:16px; border:1px solid #7c3aed55;">
      <h3 style="color:#a78bfa;">OpenRouter (Lista Atualizada Automaticamente)</h3>
      <p style="color:#94a3b8; font-size:0.8rem; margin-bottom:0.5rem;">Carregando modelos do OpenRouter...</p>
      
      <select id="openrouter-model-select" style="width:100%; padding:0.8rem; margin:0.8rem 0; background:#1e293b; color:white; border:1px solid #7c3aed55;">
        <option value="z-ai/glm-4.5-air:free" selected>GLM-4 (Free) (Padrão)</option>
        <option value="openai/gpt-4o">GPT-4o</option>
      </select>
      
      <input id="openrouter-key" type="text" placeholder="Cole sua API Key OpenRouter aqui" style="width:100%; padding:0.8rem; background:#1e293b; color:white; border:1px solid #7c3aed55;" />
      <button onclick="saveConfig('openrouter')" class="btn-cta" style="margin-top:1rem; width:100%; background: linear-gradient(90deg, #7c3aed, #c084fc);">Salvar OpenRouter</button>
    </div>

    <!-- Grok (xAI) -->
    <div class="card" style="background:rgba(30,41,59,0.8); padding:2rem; border-radius:16px; border:1px solid #00d4ff55;">
      <h3 style="color:#00d4ff;">Grok (xAI)</h3>
      <input id="grok-key" type="text" placeholder="Cole sua API Key Grok aqui" style="width:100%; padding:0.8rem; background:#1e293b; color:white; border:1px solid #00d4ff55;" />
      <button onclick="saveConfig('grok')" class="btn-cta" style="margin-top:1rem; width:100%;">Salvar Grok</button>
    </div>

    <!-- DeepSeek -->
    <div class="card" style="background:rgba(30,41,59,0.8); padding:2rem; border-radius:16px; border:1px solid #00d4ff55;">
      <h3 style="color:#00d4ff;">DeepSeek</h3>
      <input id="deepseek-key" type="text" placeholder="Cole sua API Key DeepSeek aqui" style="width:100%; padding:0.8rem; background:#1e293b; color:white; border:1px solid #00d4ff55;" />
      <button onclick="saveConfig('deepseek')" class="btn-cta" style="margin-top:1rem; width:100%;">Salvar DeepSeek</button>
    </div>

  </div>

  <div style="margin-top:3rem; text-align:center;">
    <button class="btn-cta" style="font-size:1.3rem; padding:1rem 3rem;" onclick="window.location.href='/demo'">Aplicar Configuração e Testar Demo</button>
  </div>

</Layout>

<script is:inline>
  const API_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:8080' 
      : 'https://api.getnexo.com.br';

  async function saveConfig(type) {
      const geminiKey = document.getElementById('gemini-key').value;
      const openRouterKey = document.getElementById('openrouter-key').value;
      const grokKey = document.getElementById('grok-key').value;
      const deepseekKey = document.getElementById('deepseek-key').value;
      
      const payload = {};
      if (type === 'gemini') payload.geminiKey = geminiKey;
      if (type === 'openrouter') payload.openRouterKey = openRouterKey;
      if (type === 'grok') payload.grokKey = grokKey;
      if (type === 'deepseek') payload.deepseekKey = deepseekKey;

      try {
          const res = await fetch(`${API_URL}/api/admin/config`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (data.success) {
              alert('✅ API Key salva com sucesso!');
          } else {
              alert('❌ Erro ao salvar configuração.');
          }
      } catch (e) {
          console.error(e);
          alert('❌ Erro de conexão com o servidor.');
      }
  }

  // Auto-update OpenRouter Models
  async function fetchOpenRouterModels() {
    const select = document.getElementById('openrouter-model-select');
    try {
      const response = await fetch('https://openrouter.ai/api/v1/models');
      const data = await response.json();
      
      if (data && data.data) {
        // Sort models by name
        const models = data.data.sort((a, b) => a.name.localeCompare(b.name));
        
        // Keep existing options but add separator
        const initialOptions = select.innerHTML;
        let newOptions = '<optgroup label="Recomendados">' + initialOptions + '</optgroup>';
        newOptions += '<optgroup label="Todos os Modelos">';
        
        models.forEach(model => {
             // Avoid duplicates
             if (!initialOptions.includes(model.id)) {
                 newOptions += `<option value="${model.id}">${model.name} (${model.pricing?.prompt === '0' ? 'Free' : '$'})</option>`;
             }
        });
        
        newOptions += '</optgroup>';
        select.innerHTML = newOptions;
        select.previousElementSibling.innerText = `Total de ${models.length} modelos carregados em tempo real.`;
      }
    } catch (e) {
      console.error('Failed to fetch OpenRouter models', e);
      select.previousElementSibling.innerText = 'Erro ao carregar lista. Usando modelos padrão.';
    }
  }

  // Run on load
  fetchOpenRouterModels();
</script>

<style>
  .btn-cta {
    background: linear-gradient(90deg, #00d4ff, #00ff9d);
    color: black;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 50px;
    font-weight: bold;
    cursor: pointer;
  }
</style>
