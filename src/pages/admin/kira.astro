
---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Kira War Room | JetNexo">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <div class="min-h-screen bg-black text-white p-6 font-mono">
        <div class="max-w-6xl mx-auto">
            <header class="flex justify-between items-center mb-10 border-b border-red-900/30 pb-4">
                <h1 class="text-4xl font-bold text-red-600 flex items-center gap-3">
                    <span class="animate-pulse">üî•</span> KIRA 2.0 <span class="text-sm text-gray-500 font-normal">WAR ROOM</span>
                </h1>
                <div class="flex gap-4">
                    <button id="force-run" class="bg-red-900/30 hover:bg-red-600 text-red-500 hover:text-white px-4 py-2 border border-red-800 rounded transition-all text-xs uppercase tracking-widest">
                        ‚ö° Force Audit
                    </button>
                    <a href="/" class="text-gray-600 hover:text-white text-xs self-center">EXIT</a>
                </div>
            </header>

            <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Col 1: Charts -->
                <div class="md:col-span-2 space-y-6">
                    <!-- Performance Chart -->
                    <div class="bg-gray-900/50 border border-gray-800 p-4 rounded-xl backdrop-blur-sm">
                        <h3 class="text-gray-400 text-xs uppercase tracking-wider mb-4">Lighthouse Velocity</h3>
                        <canvas id="perfChart" height="100"></canvas>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <!-- Ranking List -->
                        <div class="bg-gray-900/50 border border-gray-800 p-4 rounded-xl">
                            <h3 class="text-gray-400 text-xs uppercase tracking-wider mb-4">Keyword Dominance</h3>
                            <div id="rankingList" class="space-y-3 text-sm">
                                <div class="animate-pulse text-gray-600">Scanning SERPs...</div>
                            </div>
                        </div>

                        <!-- Heatmap List -->
                        <div class="bg-gray-900/50 border border-gray-800 p-4 rounded-xl">
                            <h3 class="text-gray-400 text-xs uppercase tracking-wider mb-4">Mental Heatmap</h3>
                            <div id="heatmapList" class="space-y-3 text-sm">
                                <div class="animate-pulse text-gray-600">Tracking Retina...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Col 2: The Report -->
                <div class="md:col-span-1">
                    <div class="bg-black border border-red-900/50 p-6 rounded-xl h-full shadow-[0_0_30px_rgba(255,0,0,0.1)]">
                        <h3 class="text-red-500 text-xs uppercase tracking-wider mb-4 border-b border-red-900/30 pb-2">Daily Briefing</h3>
                        <div id="kira-report" class="prose prose-invert prose-red prose-sm max-w-none h-[600px] overflow-y-auto custom-scrollbar">
                           <div class="text-gray-600 italic">Waiting for intelligence...</div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
</Layout>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #000; }
</style>

<script is:inline>
    // Initialize Charts
    let perfChartInstance = null;

    async function initDashboard() {
        // Fetch Data
        const [repRes, heatRes] = await Promise.all([
            fetch('/kira_status.json'),
            fetch('/api/monitor/heat-map')
        ]);
        
        try {
            const repData = await repRes.json();
            const heatData = await heatRes.json();

            // Render Report
            document.getElementById('kira-report').innerHTML = marked.parse(repData.report);

            // Render Perf Chart
            const ctx = document.getElementById('perfChart').getContext('2d');
            if (perfChartInstance) perfChartInstance.destroy();
            
            perfChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Performance Score',
                        data: heatData.perf,
                        borderColor: '#FFD500',
                        backgroundColor: 'rgba(255, 213, 0, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { min: 90, max: 100, grid: { color: '#333' } }, x: { grid: { display: false } } }
                }
            });

            // Render Ranking
            const rankHTML = heatData.ranking.map(r => `
                <div class="flex justify-between items-center bg-black/50 p-2 rounded">
                    <span class="text-gray-300 font-bold">#${r.pos}</span>
                    <span class="text-gray-400 flex-1 ml-3 truncate">${r.keyword}</span>
                    <span class="${r.var.includes('+') ? 'text-green-500' : 'text-red-500'} font-mono text-xs">${r.var}</span>
                </div>
            `).join('');
            document.getElementById('rankingList').innerHTML = rankHTML;

            // Render Heatmap
            const heatHTML = heatData.heatmap.map(h => `
                <div class="group">
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-gray-400">${h.page}</span>
                        <span class="${h.warm > 80 ? 'text-red-500' : 'text-yellow-500'}">${h.warm}%</span>
                    </div>
                    <div class="w-full bg-gray-800 rounded-full h-1.5">
                        <div class="bg-gradient-to-r from-yellow-500 to-red-600 h-1.5 rounded-full" style="width: ${h.warm}%"></div>
                    </div>
                </div>
            `).join('');
            document.getElementById('heatmapList').innerHTML = heatHTML;

        } catch (e) {
            console.error("Dashboard Load Error", e);
        }
    }

    // Force Run Logic
    document.getElementById('force-run').addEventListener('click', async () => {
        const btn = document.getElementById('force-run');
        const originalText = btn.innerText;
        btn.innerText = "‚è≥ EXECUTING...";
        btn.disabled = true;
        
        try {
            await fetch('/api/monitor/daily-report');
            setTimeout(() => {
                initDashboard();
                btn.innerText = originalText;
                btn.disabled = false;
            }, 2000);
        } catch (e) {
            btn.innerText = "‚ùå ERROR";
        }
    });

    // Auto-Run
    initDashboard();
</script>
