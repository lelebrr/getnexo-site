---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="Relat贸rio GetNexo">
  <div style="background:#0a0e17; min-height:100vh; padding:2rem; color:white;">
      <div style="max-width:800px; mx-auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2 style="color:#00ff9d; font-size:2rem; margin:0;">Relat贸rio Mensal</h2>
            <button onclick="window.location.href='/admin'" style="background:transparent; border:1px solid #374151; color:#9ca3af; padding:0.5rem 1rem; border-radius:8px; cursor:pointer;">Voltar</button>
        </div>

        <div class="card">
            <div id="loading" style="text-align:center; color:#666;">Carregando dados...</div>
            <div id="stats" style="display:none;">
                <div class="stat-row">
                    <p>Total Vendas</p>
                    <strong id="val-vendas" style="color:#00ff9d; font-size:1.5rem;">R$ 0,00</strong>
                </div>
                <div class="stat-row">
                    <p>Pedidos Fechados</p>
                    <strong id="val-pedidos">0</strong>
                </div>
                <div class="stat-row">
                    <p>Conversas Iniciadas</p>
                    <strong id="val-conversas">0</strong>
                </div>
                <div class="stat-row">
                    <p>Taxa de Convers茫o</p>
                    <strong id="val-taxa" style="color:#00d4ff;">0%</strong>
                </div>
                <div class="stat-row" style="border-bottom:none;">
                    <p>Comiss玫es (Revenda)</p>
                    <strong id="val-comissoes" style="color:#fbbf24;">R$ 0,00</strong>
                </div>
            </div>
        </div>

        <div style="margin-top:2rem; text-align:right;">
            <button class="btn-cta" onclick="baixarPDF()"> Exportar PDF</button>
        </div>
      </div>
  </div>

  <script is:inline>
    // Fetch Data on Load
    fetch('https://api.getnexo.com.br/api/relatorio')
        .then(r => r.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('stats').style.display = 'block';
            
            document.getElementById('val-vendas').innerText = 'R$ ' + data.totalVendas.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('val-pedidos').innerText = data.pedidos;
            document.getElementById('val-conversas').innerText = data.conversas;
            
            const taxa = data.conversas > 0 ? ((data.pedidos / data.conversas) * 100).toFixed(1) : 0;
            document.getElementById('val-taxa').innerText = taxa + '%';
            
            // Calc estimated commission (10% of sales for demo)
            const comissao = data.totalVendas * 0.1;
            document.getElementById('val-comissoes').innerText = 'R$ ' + comissao.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            
            window.reportData = { ...data, taxa, comissao };
        })
        .catch(e => {
            document.getElementById('loading').innerText = 'Erro ao carregar relat贸rio.';
        });

    async function baixarPDF() {
      const data = window.reportData || { totalVendas: 0, pedidos: 0, conversas: 0 };

      // Gera PDF (simulado - abrindo nova janela de impress茫o)
      const win = window.open('', '_blank');
      win.document.write(`
        <html>
        <head>
            <title>Relat贸rio GetNexo - ${new Date().toLocaleDateString()}</title>
            <style>
                body { font-family: sans-serif; padding: 40px; }
                h1 { color: #000; border-bottom: 2px solid #00ff9d; padding-bottom: 10px; }
                .item { margin-bottom: 20px; font-size: 18px; border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; }
                .val { font-weight: bold; }
                .footer { margin-top: 50px; font-size: 12px; color: #666; text-align: center; }
            </style>
        </head>
        <body>
          <h1>Relat贸rio Mensal GetNexo</h1>
          <div class="item"><span>Total Vendas:</span> <span class="val">R$ ${data.totalVendas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div>
          <div class="item"><span>Pedidos:</span> <span class="val">${data.pedidos}</span></div>
          <div class="item"><span>Conversas:</span> <span class="val">${data.conversas}</span></div>
          <div class="item"><span>Taxa de Convers茫o:</span> <span class="val">${data.taxa}%</span></div>
          <div class="item"><span>Comiss玫es Pagas:</span> <span class="val">R$ ${data.comissao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div>
          
          <div class="footer">Gerado em ${new Date().toLocaleString()} por GetNexo Admin</div>
          <script>window.print();</script>
        </body></html>
      `);
    }
  </script>
</Layout>

<style>
  .card {
    background: rgba(30,41,59,0.6);
    border-radius: 16px;
    padding: 2rem;
    border: 1px solid #374151;
    backdrop-filter: blur(10px);
  }
  .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid #374151;
  }
  .stat-row p { margin: 0; color: #9ca3af; }
  .btn-cta {
    background: linear-gradient(90deg, #00d4ff, #00ff9d);
    color: black;
    padding: 0.8rem 2rem;
    border: none;
    border-radius: 50px;
    font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
  }
  .btn-cta:hover { opacity: 0.9; }
</style>
