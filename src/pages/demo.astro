---
import Layout from '../layouts/Layout.astro';
const title = "Demo Gr√°tis WhatsApp IA GetNexo - Teste Assistente de Vendas Inteligente Agora Mesmo 2026";
const description = "Teste gr√°tis a demo interativa do GetNexo: converse com IA de vendas WhatsApp, veja automa√ß√£o em a√ß√£o, recupera√ß√£o de carrinho, PIX no chat. Sem instala√ß√£o, 100% gratuita!";
const keywords = "demo whatsapp ia getnexo gratis, teste assistente vendas whatsapp, demo automacao whatsapp vendas, ia vendas whatsapp demo, chat inteligente whatsapp demo, recuperacao carrinho demo, pix whatsapp demo gratis, getnexo demo interativa 2026";
const ogImage = "https://getnexo.com.br/assets/og-poster.jpg";
---
<Layout title={title} description={description} keywords={keywords} ogImage={ogImage}>
  <section style="padding: 6rem 10%; max-width: 1200px; margin: 0 auto; color: #e5e7eb; text-align: center;">
    <h1 style="color:#00ff9d; font-size: 3rem;">Demonstra√ß√£o Interativa</h1>
    <p style="font-size: 1.3rem; margin: 1rem 0 3rem; color: #94a3b8;">Veja o GetNexo em a√ß√£o ‚Äì converse com nossa IA agora mesmo</p>
    

    <!-- Stage 1: Lead Form -->
    <div id="demo-stage-1" style="background: rgba(20,30,50,0.8); border-radius: 16px; padding: 3rem; border: 1px solid #00d4ff55; max-width: 500px; margin: 0 auto; text-align: left;">
      <h3 style="color: #00ff9d; margin-bottom: 1rem; text-align: center;">üöÄ Testar Atendimento IA</h3>
      <p style="color: #94a3b8; text-align: center; margin-bottom: 2rem;">Preencha para iniciar a demonstra√ß√£o</p>
      
      <form id="lead-form" style="display: flex; flex-direction: column; gap: 1rem;">
        <input type="text" id="lead-name" placeholder="Seu Nome" required style="padding: 1rem; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px;" />
        
        <input type="tel" id="lead-phone" placeholder="Seu WhatsApp (99) 99999-9999" required 
               maxlength="15"
               maxlength="15"
               style="padding: 1rem; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px;" />
        
        <input type="email" id="lead-email" placeholder="Seu E-mail Corporativo" required style="padding: 1rem; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px;" />
        <button type="submit" style="background: linear-gradient(90deg, #00d4ff, #00ff9d); color: black; padding: 1rem; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; margin-top: 1rem;">Continuar ‚Üí</button>
      </form>
    </div>

    <!-- Stage 2: Industry Selection -->
    <div id="demo-stage-2" style="display: none; background: rgba(20,30,50,0.8); border-radius: 16px; padding: 3rem; border: 1px solid #00d4ff55; max-width: 800px; margin: 0 auto;">
      <h3 style="color: #00d4ff; margin-bottom: 2rem;">üè¢ Qual √© o seu segmento?</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
        {['Moda & Vestu√°rio', 'Eletr√¥nicos', 'Auto Pe√ßas', 'Cosm√©ticos', 'Alimenta√ß√£o/Delivery', 'M√≥veis & Decora√ß√£o', 'Pet Shop', 'Servi√ßos/Infoproduto', 'Imobili√°ria', 'Concession√°ria', 'Outros'].map(item => (
          <button class="industry-btn" onclick={`selectIndustry('${item}')`} style="padding: 1rem; background: #1e293b; border: 1px solid #334155; color: white; border-radius: 8px; cursor: pointer; transition: all 0.3s;">{item}</button>
        ))}
      </div>
    </div>

    <!-- Stage 3: Chat -->
    <div id="demo-stage-3" style="display: none; background: rgba(20,30,50,0.8); border-radius: 16px; padding: 3rem; border: 1px solid #00d4ff55; max-width: 600px; margin: 0 auto;">
      <div style="text-align: left; margin-bottom: 2rem;">
        <h3 style="color: #00d4ff; margin-bottom: 0.5rem;" id="chat-title">üí¨ Chat Inteligente</h3>
        <p style="color: #94a3b8; font-size: 0.9rem;">A IA vai simular um vendedor especialista no seu nicho.</p>
      </div>
      
      <div id="chat-messages" style="background: #0a0e17; border-radius: 12px; padding: 1.5rem; min-height: 300px; max-height: 400px; overflow-y: auto; margin-bottom: 1.5rem; text-align: left;">
        <div class="msg-bot">
          <span style="color: #00ff9d; font-size: 0.8rem;">ü§ñ GetNexo Bot</span>
          <p style="background: #1e293b; padding: 0.8rem; border-radius: 8px; margin: 0.3rem 0 1rem; color: white;">
            Ol√°! Vi que voc√™ trabalha com <b id="chat-industry-display">...</b>. 
            Como posso otimizar suas vendas hoje? Quer ver uma automa√ß√£o de recupera√ß√£o de carrinho ou atendimento de suporte?
          </p>
        </div>
      </div>
      
      <form id="chat-form" style="display: flex; gap: 0.5rem; align-items: center;">
        <input type="text" id="chat-input" placeholder="Digite ou fale..." style="flex: 1; padding: 1rem; border-radius: 8px; background: #1e293b; color: white; border: 1px solid #334155; font-size: 1rem;" />
        
        <!-- Mic Button -->
        <button type="button" id="btn-mic" onclick="toggleMic()" style="background: #334155; color: white; width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.2s;">
            üé§
        </button>

        <button type="submit" style="background: linear-gradient(90deg, #00d4ff, #00ff9d); color: black; padding: 0 1.5rem; height: 50px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">Enviar</button>
      </form>
    </div>
    
  </section>

  <style>
    .industry-btn:hover { border-color: #00ff9d !important; background: #00d4ff22 !important; }

    .chat-car-img {
        width: 100%;
        height: auto;
        max-height: 250px;
        object-fit: cover;
        border-radius: 8px;
        margin-top: 12px;
        cursor: zoom-in;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #334155;
        display: block;
    }
    .chat-car-img:hover {
        transform: scale(1.02);
        border-color: #00ff9d;
        box-shadow: 0 4px 12px rgba(0, 255, 157, 0.2);
    }
    .btn-360 {
        background: rgba(0, 212, 255, 0.15);
        border: 1px solid #00d4ff;
        color: #00d4ff;
        padding: 8px 16px;
        border-radius: 20px;
        margin-top: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-size: 0.9rem;
        transition: all 0.2s;
        width: 100%;
        text-align: center;
        white-space: nowrap;
    }
    .btn-360:hover {
        background: rgba(0, 212, 255, 0.3);
        box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        transform: translateY(-1px);
    }
    /* Mic Pulse Animation */
    @keyframes pulse-mic {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 157, 0.7); }
        70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(0, 255, 157, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 157, 0); }
    }
    .mic-active {
        background: #00ff9d !important;
        color: black !important;
        animation: pulse-mic 1.5s infinite;
    }
    
    /* Scrollbar cleanup */
    #chat-messages::-webkit-scrollbar { width: 6px; }
    #chat-messages::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
  </style>

  <script is:inline>
    const API_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:8080' 
      : 'https://api.getnexo.com.br';
    
    let leadData = {};
    let selectedIndustry = '';

    // Elements
    const stage1 = document.getElementById('demo-stage-1');
    const stage2 = document.getElementById('demo-stage-2');
    const stage3 = document.getElementById('demo-stage-3');
    const chatTitle = document.getElementById('chat-industry-display');

    // Phone formatting
    const phoneInput = document.getElementById('lead-phone');
    if (phoneInput) {
      phoneInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g,'');
        this.value = value.replace(/^(\d{2})(\d)/g,'($1) $2').replace(/(\d)(\d{4})$/,'$1-$2');
      });
    }

    // Stage 1: Lead Form Submit
    document.getElementById('lead-form').onsubmit = (e) => {
      e.preventDefault();
      leadData = {
        name: document.getElementById('lead-name').value,
        phone: document.getElementById('lead-phone').value,
        email: document.getElementById('lead-email').value
      };
      
      // Transition
      stage1.style.display = 'none';
      stage2.style.display = 'block';
    };

    // Stage 2: Select Industry (Global function for inline onclick)
    window.selectIndustry = (industry) => {
      selectedIndustry = industry;
      chatTitle.innerText = industry;
      
      stage2.style.display = 'none';
      stage3.style.display = 'block';

      // Send initial context to backend (optional warmup)
      console.log('Demo started for:', leadData, selectedIndustry);
    };

    // Chat Logic
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const btnMic = document.getElementById('btn-mic');

    const scrollToBottom = () => { chatMessages.scrollTop = chatMessages.scrollHeight; };

    function addMessage(text, isBot) {
      const div = document.createElement('div');
      div.style.textAlign = isBot ? 'left' : 'right'; // Align bubbles
      
      // Parse Markdown/Custom Tags to HTML
      let formattedText = text
          // Convert IMAGEM: url to Image + Zoom
          .replace(/IMAGEM:\s*(https?:\/\/[^\s]+)/g, '<img src="$1" class="chat-car-img" onclick="zoomImage(\'$1\')" alt="Ve√≠culo">')
          // Convert 360 Link to Button
          .replace(/360:\s*(https?:\/\/[^\s]+)/g, '<button class="btn-360" onclick="open360(\'$1\')">üîÑ Girar 360¬∫</button>')
          // Bold
          .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
          // Line breaks
          .replace(/\n/g, '<br>');

      // TTS Button for Bot
      let ttsBtn = '';
      if (isBot) {
         // Create a cleaner text for speaking (remove URLs)
         const cleanText = text.replace(/IMAGEM:.*?(\s|$)/g, '').replace(/360:.*?(\s|$)/g, '').replace(/\*/g, '');
         ttsBtn = `<button onclick="speakText(this, '${cleanText.replace(/'/g, "\\'")}')" style="background:none; border:none; color:#00ff9d; cursor:pointer; margin-left:10px; font-size:1.1rem;">üîä</button>`;
      }

      div.innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:${isBot ? 'flex-start' : 'flex-end'};">
            <span style="color: ${isBot ? '#00ff9d' : '#00d4ff'}; font-size: 0.8rem; margin-bottom:4px;">
                ${isBot ? 'ü§ñ GetNexo Bot' : 'üë§ Voc√™'} ${ttsBtn}
            </span>
            <div style="background: ${isBot ? '#1e293b' : '#00d4ff22'}; padding: 0.8rem; border-radius: 12px; border-top-${isBot ? 'left' : 'right'}-radius: 0; color: white; display:inline-block; text-align:left; max-width:90%;">
                ${formattedText}
            </div>
        </div>
      `;
      chatMessages.appendChild(div);
      scrollToBottom();
      
      // Auto-speak if new bot message? (Optional, maybe annoying. Let's keep manual play)
    }
    
    // --- AUDIO LOGIC ---
    let recognition;
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'pt-BR';
        recognition.interimResults = false;

        recognition.onstart = () => {
            btnMic.classList.add('mic-active');
            chatInput.placeholder = "Ouvindo...";
        };
        recognition.onend = () => {
            btnMic.classList.remove('mic-active');
            chatInput.placeholder = "Digite ou fale...";
        };
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            chatInput.value = transcript;
            // Optional: Auto-send
            // chatForm.dispatchEvent(new Event('submit')); 
            // Better to let user review
        };
    } else {
        btnMic.style.display = 'none'; // Hide if not supported
    }

    window.toggleMic = () => {
        if (!recognition) return alert('Seu navegador n√£o suporta reconhecimento de voz.');
        if (btnMic.classList.contains('mic-active')) {
            recognition.stop();
        } else {
            recognition.start();
        }
    };

    window.speakText = (btn, text) => {
        if ('speechSynthesis' in window) {
            // Stop current
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR';
            utterance.rate = 1.1; // Slightly faster natural speed
            
            // Visual feedback
            const originalIcon = btn.innerHTML;
            btn.innerHTML = 'üîà'; // Playing icon
            
            utterance.onend = () => { btn.innerHTML = originalIcon; };
            
            window.speechSynthesis.speak(utterance);
        } else {
            alert('√Åudio n√£o suportado neste navegador.');
        }
    };
    // -------------------

    // Lightbox Logic
    window.zoomImage = (src) => {
        const modal = document.createElement('div');
        modal.id = 'img-modal';
        modal.style.cssText = `position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; justify-content:center; align-items:center; z-index:9999; cursor:zoom-out; flex-direction:column;`;
        
        const img = document.createElement('img');
        img.src = src;
        img.style.cssText = "max-width:95%; max-height:85vh; object-fit:contain; border-radius:8px; box-shadow:0 0 50px rgba(0,255,157,0.2);";
        
        const closeBtn = document.createElement('div');
        closeBtn.innerHTML = "‚úï Fechar Zoom";
        closeBtn.style.cssText = "color:white; margin-top:15px; border:1px solid #777; padding:8px 20px; border-radius:30px; cursor:pointer; font-size:0.9rem; background:rgba(0,0,0,0.5);";
        
        modal.appendChild(img);
        modal.appendChild(closeBtn);
        modal.onclick = () => modal.remove();
        document.body.appendChild(modal);
    };

    window.open360 = (link) => {
        if (!link || link === '[LINK_360]') {
            alert('Visualiza√ß√£o 360 n√£o dispon√≠vel para este modelo.');
            return;
        }

        const modal = document.createElement('div');
        modal.style.cssText = `position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; justify-content:center; align-items:center; z-index:9999; flex-direction:column;`;
        
        modal.innerHTML = `
            <div style="background:#1e293b; padding:0; border-radius:12px; width:95%; max-width:1100px; height:80vh; display:flex; flex-direction:column; border:1px solid #00d4ff; overflow:hidden;">
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#0f172a; border-bottom:1px solid #334155;">
                    <h3 style="color:#00d4ff; margin:0; font-size:1rem;">üîÑ CarShow360 Experience</h3>
                    <button onclick="this.closest('div').parentElement.parentElement.remove()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">‚úï</button>
                </div>
                <div style="flex:1; background:#fff; position:relative;">
                    <iframe src="${link}" style="width:100%; height:100%; border:none;" allowfullscreen loading="lazy"></iframe>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    };

    chatForm.onsubmit = async (e) => {
      e.preventDefault();
      const msg = chatInput.value.trim();
      if (!msg) return;

      addMessage(msg, false);
      chatInput.value = '';

      try {
        const res = await fetch(`${API_URL}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mensagem: msg,
            iaSelecionada: 'openrouter', // Force OpenRouter or dynamic
            model: 'z-ai/glm-4.5-air:free',
            apiKey: '', // Will use backend configured key
            context: {
                industry: selectedIndustry,
                lead: leadData
            }
          })
        });
        const data = await res.json();
        addMessage(data.resposta, true);
      } catch (e) {
         addMessage('Erro de conex√£o. Tente novamente.', true);
      }
    };
  </script>



