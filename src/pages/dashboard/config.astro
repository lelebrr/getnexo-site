---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Configura√ß√£o IA | OmniNexo">
    <h2 style="font-size:2rem; font-weight:800; color:white; margin-bottom:2rem;">C√©rebro da IA üß†</h2>

    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(400px, 1fr)); gap:2rem;">
        
        <!-- API Keys -->
        <div class="glass-panel" style="padding:2rem;">
            <h3 style="margin-top:0; color:#00ff9d;">Chaves de API</h3>
            <p style="color:#94a3b8; font-size:0.9rem;">Configure os provedores de intelig√™ncia.</p>
            
            <form id="keys-form" style="display:flex; flex-direction:column; gap:1.5rem; margin-top:1.5rem;">
                <div>
                    <label style="color:#e5e7eb; font-weight:bold;">Google Gemini API Key</label>
                    <input type="password" id="geminiKey" placeholder="AIzaSy..." style="width:100%; padding:1rem; background:#0f172a; border:1px solid #334155; color:white; border-radius:8px; margin-top:0.5rem;" />
                    <div style="font-size:0.8rem; color:#64748b; margin-top:0.3rem;">Status Env: <span id="status-gemini">...</span></div>
                </div>

                <div>
                    <label style="color:#e5e7eb; font-weight:bold;">OpenRouter API Key (Opcional)</label>
                    <input type="password" id="openRouterKey" placeholder="sk-or-..." style="width:100%; padding:1rem; background:#0f172a; border:1px solid #334155; color:white; border-radius:8px; margin-top:0.5rem;" />
                </div>

                <div>
                    <label style="color:#e5e7eb; font-weight:bold;">Setor Principal</label>
                    <select id="industry" style="width:100%; padding:1rem; background:#0f172a; border:1px solid #334155; color:white; border-radius:8px; margin-top:0.5rem;">
                        <option value="Geral">Geral (Padr√£o)</option>
                        <option value="Moda & Vestu√°rio">Moda & Vestu√°rio</option>
                        <option value="Eletr√¥nicos">Eletr√¥nicos</option>
                        <option value="Restaurante/Delivery">Restaurante/Delivery</option>
                        <option value="Imobili√°ria">Imobili√°ria</option>
                        <option value="Concession√°ria">Concession√°ria</option>
                        <option value="Servi√ßos">Servi√ßos</option>
                    </select>
                </div>
                
                <button type="submit" style="padding:12px; background:#00ff9d; color:black; font-weight:bold; border:none; border-radius:8px; cursor:pointer; margin-top:1rem;">
                    Salvar Configura√ß√µes
                </button>
            </form>
        </div>

        <!-- Knowledge Base -->
        <div class="glass-panel" style="padding:2rem;">
            <h3 style="margin-top:0; color:#00d4ff;">Base de Conhecimento</h3>
            <p style="color:#94a3b8; font-size:0.9rem;">O que a IA precisa saber sobre sua empresa al√©m do cat√°logo.</p>
            
            <form id="context-form" style="display:flex; flex-direction:column; gap:1rem; margin-top:1.5rem; height:80%;">
                <textarea id="context-area" placeholder="Ex: Somos uma loja fundada em 2010. Aceitamos PIX e Cart√£o. Frete gr√°tis acima de R$ 200. Hor√°rio de atendimento..." style="flex:1; padding:1rem; background:#0f172a; border:1px solid #334155; color:white; border-radius:8px; resize:none; min-height:300px; font-family:monospace; line-height:1.5;"></textarea>
                
                <button type="submit" style="padding:12px; background:#00d4ff; color:black; font-weight:bold; border:none; border-radius:8px; cursor:pointer;">
                    Atualizar C√©rebro
                </button>
            </form>
        </div>

    </div>

    <script is:inline>
        const API = 'https://api.getnexo.com.br';

        // Load Config
        async function loadConfig() {
            try {
                const res = await fetch(`${API}/api/config`, {
                    headers: window.getAuthHeader()
                });
                const data = await res.json();
                
                if (data.geminiKey) document.getElementById('geminiKey').value = data.geminiKey;
                if (data.openRouterKey) document.getElementById('openRouterKey').value = data.openRouterKey;
                if (data.industry) document.getElementById('industry').value = data.industry;
                
                document.getElementById('status-gemini').innerText = data.envGemini ? '‚úÖ Definido no Docker' : '‚ö†Ô∏è N√£o definido';
                document.getElementById('status-gemini').style.color = data.envGemini ? '#00ff9d' : '#facc15';
            } catch (e) { console.error(e); }
        }

        // Load Context
        async function loadContext() {
            try {
                const res = await fetch(`${API}/ai-context`, {
                    headers: window.getAuthHeader()
                });
                const data = await res.json();
                document.getElementById('context-area').value = data.content || '';
            } catch (e) { console.error(e); }
        }

        // Save Config
        document.getElementById('keys-form').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                geminiKey: document.getElementById('geminiKey').value,
                openRouterKey: document.getElementById('openRouterKey').value,
                industry: document.getElementById('industry').value
            };
            
            try {
                const res = await fetch(`${API}/api/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...window.getAuthHeader()
                    },
                    body: JSON.stringify(payload)
                });
                if (res.ok) alert('‚úÖ Configura√ß√µes salvas!');
                else alert('Erro ao salvar.');
            } catch (e) { alert('Erro de conex√£o.'); }
        };

        // Save Context
        document.getElementById('context-form').onsubmit = async (e) => {
            e.preventDefault();
            const content = document.getElementById('context-area').value;
            
            try {
                const res = await fetch(`${API}/ai-context`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...window.getAuthHeader()
                    },
                    body: JSON.stringify({ content })
                });
                if (res.ok) alert('‚úÖ C√©rebro atualizado!');
                else alert('Erro ao atualizar.');
            } catch (e) { alert('Erro de conex√£o.'); }
        };

        loadConfig();
        loadContext();
    </script>
</DashboardLayout>
