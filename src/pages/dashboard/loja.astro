---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Loja e Cat√°logo | OmniNexo">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
        <div>
            <h2 style="font-size:2rem; font-weight:800; color:white; margin:0;">Cat√°logo de Produtos üè∑Ô∏è</h2>
            <p style="color:#94a3b8; margin:0.5rem 0 0;">Produtos que a IA pode vender e consultar.</p>
        </div>
        <button onclick="openModal()" style="background:#00d4ff; color:black; font-weight:bold; padding:10px 20px; border:none; border-radius:30px; cursor:pointer; box-shadow:0 0 15px rgba(0,212,255,0.3);">
            + Novo Produto
        </button>
    </div>

    <!-- Product Grid -->
    <div id="product-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:1.5rem;">
        <!-- Loaded via JS -->
    </div>

    <!-- Add/Edit Modal -->
    <div id="product-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(5px); z-index:1000; align-items:center; justify-content:center;">
        <div class="glass-panel" style="background:#0f172a; border:1px solid #334155; padding:2rem; width:90%; max-width:500px; position:relative;">
            <h3 id="modal-title" style="margin-top:0; color:white;">Novo Produto</h3>
            
            <form id="product-form" style="display:flex; flex-direction:column; gap:1rem;">
                <input type="hidden" name="id" id="prod-id" />
                
                <div>
                    <label style="color:#94a3b8; font-size:0.9rem;">Nome do Produto</label>
                    <input name="name" id="prod-name" required placeholder="Ex: T√™nis Nike Air" style="width:100%; padding:0.8rem; background:#1e293b; border:1px solid #334155; color:white; border-radius:8px; margin-top:0.3rem;" />
                </div>

                <div style="display:flex; gap:1rem;">
                    <div style="flex:1;">
                        <label style="color:#94a3b8; font-size:0.9rem;">Pre√ßo (R$)</label>
                        <input type="number" step="0.01" name="price" id="prod-price" required placeholder="0.00" style="width:100%; padding:0.8rem; background:#1e293b; border:1px solid #334155; color:white; border-radius:8px; margin-top:0.3rem;" />
                    </div>
                    <div style="flex:1;">
                        <label style="color:#94a3b8; font-size:0.9rem;">Estoque</label>
                        <input type="number" name="stock" id="prod-stock" value="10" style="width:100%; padding:0.8rem; background:#1e293b; border:1px solid #334155; color:white; border-radius:8px; margin-top:0.3rem;" />
                    </div>
                </div>

                <div>
                    <label style="color:#94a3b8; font-size:0.9rem;">Link da Imagem</label>
                    <input name="image_url" id="prod-img" placeholder="https://..." style="width:100%; padding:0.8rem; background:#1e293b; border:1px solid #334155; color:white; border-radius:8px; margin-top:0.3rem;" />
                </div>

                <div>
                    <label style="color:#94a3b8; font-size:0.9rem;">Descri√ß√£o (para a IA)</label>
                    <textarea name="description" id="prod-desc" rows="3" placeholder="Detalhes t√©cnicos, materiais, benef√≠cios..." style="width:100%; padding:0.8rem; background:#1e293b; border:1px solid #334155; color:white; border-radius:8px; margin-top:0.3rem;"></textarea>
                </div>

                <div style="display:flex; gap:1rem; margin-top:1rem;">
                    <button type="button" onclick="closeModal()" style="flex:1; padding:10px; background:transparent; border:1px solid #334155; color:#94a3b8; border-radius:8px; cursor:pointer;">Cancelar</button>
                    <button type="submit" style="flex:1; padding:10px; background:#00ff9d; border:none; color:black; font-weight:bold; border-radius:8px; cursor:pointer;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script is:inline>
        const API = 'https://api.getnexo.com.br';
        let products = [];

        async function loadProducts() {
            try {
                const res = await fetch(`${API}/api/products`, {
                    headers: window.getAuthHeader()
                });
                products = await res.json();
                render();
            } catch (e) {
                console.error(e);
            }
        }

        function render() {
            const grid = document.getElementById('product-grid');
            if (products.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:3rem; color:#64748b;">Nenhum produto cadastrado.</div>';
                return;
            }

            grid.innerHTML = products.map(p => `
                <div class="glass-panel" style="padding:0; overflow:hidden; display:flex; flex-direction:column; position:relative;">
                    <div style="height:180px; background:#1e293b; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                        ${p.image_url 
                            ? `<img src="${p.image_url}" style="width:100%; height:100%; object-fit:cover;" loading="lazy" onerror="this.src='https://placehold.co/400x300?text=Sem+Imagem'"/>` 
                            : `<span style="font-size:3rem;">üì¶</span>`}
                    </div>
                    <div style="padding:1.5rem; flex:1; display:flex; flex-direction:column;">
                        <h3 style="margin:0 0 0.5rem; color:white;">${p.name}</h3>
                        <p style="color:#94a3b8; font-size:0.9rem; margin-bottom:1rem; flex:1; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;">${p.description || 'Sem descri√ß√£o'}</p>
                        
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-size:1.2rem; font-weight:bold; color:#00ff9d;">R$ ${p.price.toFixed(2)}</span>
                            <span style="font-size:0.8rem; background:#334155; padding:2px 8px; border-radius:12px; color:#e5e7eb;">Estoque: ${p.stock}</span>
                        </div>
                    </div>
                    <div style="padding:1rem; background:rgba(0,0,0,0.2); border-top:1px solid rgba(255,255,255,0.05); display:flex; gap:0.5rem;">
                        <button onclick="editProduct(${p.id})" style="flex:1; background:#334155; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer;">Editar</button>
                        <button onclick="deleteProduct(${p.id})" style="flex:1; background:rgba(239,68,68,0.2); color:#fca5a5; border:1px solid #ef4444; padding:8px; border-radius:6px; cursor:pointer;">Excluir</button>
                    </div>
                </div>
            `).join('');
        }

        function openModal(prod = null) {
            const modal = document.getElementById('product-modal');
            const form = document.getElementById('product-form');
            modal.style.display = 'flex';
            
            if (prod) {
                document.getElementById('modal-title').innerText = 'Editar Produto';
                document.getElementById('prod-id').value = prod.id;
                document.getElementById('prod-name').value = prod.name;
                document.getElementById('prod-price').value = prod.price;
                document.getElementById('prod-stock').value = prod.stock;
                document.getElementById('prod-img').value = prod.image_url || '';
                document.getElementById('prod-desc').value = prod.description || '';
            } else {
                document.getElementById('modal-title').innerText = 'Novo Produto';
                form.reset();
                document.getElementById('prod-id').value = '';
            }
        }

        function closeModal() {
            document.getElementById('product-modal').style.display = 'none';
        }

        window.editProduct = (id) => {
            const prod = products.find(p => p.id === id);
            if (prod) openModal(prod);
        };

        window.deleteProduct = async (id) => {
            if (!confirm('Tem certeza? A IA n√£o poder√° mais vender este item.')) return;
            try {
                await fetch(`${API}/api/products/${id}`, { 
                    method: 'DELETE',
                    headers: window.getAuthHeader()
                });
                loadProducts();
            } catch (e) { alert('Erro ao excluir'); }
        };

        document.getElementById('product-form').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const id = data.id;
            
            // Format types
            data.price = parseFloat(data.price);
            data.stock = parseInt(data.stock);

            try {
                const url = id ? `${API}/api/products/${id}` : `${API}/api/products`;
                const method = id ? 'PUT' : 'POST';
                
                await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        ...window.getAuthHeader()
                    },
                    body: JSON.stringify(data)
                });
                
                closeModal();
                loadProducts();
            } catch (e) {
                alert('Erro ao salvar produto.');
            }
        };

        loadProducts();
    </script>
</DashboardLayout>
